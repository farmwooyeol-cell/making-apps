<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>순무 이미지 매칭 시스템</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #2c3e50; color: #ecf0f1; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #header { padding: 20px; background: #34495e; text-align: center; border-bottom: 2px solid #8e44ad; }
        #main-content { display: flex; flex-grow: 1; padding: 20px; gap: 20px; }
        
        /* 이미지 영역 */
        .image-pane { flex: 1; background: #34495e; border-radius: 10px; padding: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .image-pane h3 { color: #fdfdfd; margin-bottom: 10px; }
        .image-box { width: 100%; height: 300px; border: 2px dashed #666; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; background: #2c3e50; border-radius: 8px; }
        .image-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .image-label { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.5); color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.9em; }

        /* 컨트롤 및 결과 영역 */
        #controls { width: 280px; background: #34495e; border-radius: 10px; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        input[type="file"] { display: none; }
        .file-upload-btn { background-color: #8e44ad; color: white; padding: 12px; border-radius: 5px; cursor: pointer; text-align: center; font-weight: bold; transition: background-color 0.3s; }
        .file-upload-btn:hover { background-color: #7d3c98; }
        .match-btn { background-color: #2ecc71; color: white; padding: 12px; border-radius: 5px; cursor: pointer; text-align: center; font-weight: bold; transition: background-color 0.3s; margin-top: 10px; }
        .match-btn:hover { background-color: #27ae60; }
        
        .result-box { background: #2c3e50; padding: 15px; border-radius: 8px; text-align: center; margin-top: 20px; }
        .result-box h4 { margin-top: 0; color: #fdfdfd; }
        .match-score { font-size: 2.5em; font-weight: bold; color: #f1c40f; } /* 기본 노란색 */
        .match-score.good { color: #2ecc71; } /* 초록색 */
        .match-score.bad { color: #e74c3c; } /* 빨간색 */
        .message { font-size: 0.9em; color: #bdc3c7; margin-top: 5px; }
    </style>
</head>
<body>

<div id="header">
    <h2>✨ 순무 뿌리 매칭 시스템</h2>
    <p>기준 이미지를 설정하고, 다른 순무 사진을 비교하여 품질을 선발합니다.</p>
</div>

<div id="main-content">
    <div class="image-pane">
        <h3>기준 순무 이미지</h3>
        <div class="image-box" id="targetImageBox">
            <img id="targetImage" src="" alt="기준 이미지" style="display: none;">
            <span id="targetPlaceholder">여기에 기준 이미지를 드래그하거나 업로드</span>
        </div>
        <label for="uploadTarget" class="file-upload-btn">기준 이미지 설정</label>
        <input type="file" id="uploadTarget" accept="image/*">
    </div>

    <div class="image-pane">
        <h3>비교할 순무 이미지</h3>
        <div class="image-box" id="currentImageBox">
            <img id="currentImage" src="" alt="비교 이미지" style="display: none;">
            <span id="currentPlaceholder">여기에 비교 이미지를 드래그하거나 업로드</span>
        </div>
        <label for="uploadCurrent" class="file-upload-btn">비교 이미지 업로드</label>
        <input type="file" id="uploadCurrent" accept="image/*">
    </div>

    <div id="controls">
        <button class="match-btn" onclick="compareImages()">유사성 분석 시작</button>
        <div class="result-box">
            <h4>매칭 점수</h4>
            <div id="matchScore" class="match-score">--%</div>
            <div id="matchMessage" class="message">분석을 시작해 주세요.</div>
        </div>
    </div>
</div>

<script>
    let targetImageSrc = null;
    let currentImageSrc = null;

    // 파일 드롭 및 업로드 핸들러
    function handleImageUpload(inputElement, imgElementId, placeholderId, isTarget) {
        inputElement.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = document.getElementById(imgElementId);
                    img.src = event.target.result;
                    img.style.display = 'block';
                    document.getElementById(placeholderId).style.display = 'none';
                    if (isTarget) {
                        targetImageSrc = event.target.result;
                    } else {
                        currentImageSrc = event.target.result;
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        // 드래그 앤 드롭 기능 추가 (각 이미지 박스에)
        const imageBoxId = imgElementId === 'targetImage' ? 'targetImageBox' : 'currentImageBox';
        const imageBox = document.getElementById(imageBoxId);

        imageBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageBox.style.borderColor = '#8e44ad';
        });
        imageBox.addEventListener('dragleave', () => {
            imageBox.style.borderColor = '#666';
        });
        imageBox.addEventListener('drop', (e) => {
            e.preventDefault();
            imageBox.style.borderColor = '#666';
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                inputElement.files = e.dataTransfer.files; // 드롭된 파일을 input 요소에 할당
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = document.getElementById(imgElementId);
                    img.src = event.target.result;
                    img.style.display = 'block';
                    document.getElementById(placeholderId).style.display = 'none';
                    if (isTarget) {
                        targetImageSrc = event.target.result;
                    } else {
                        currentImageSrc = event.target.result;
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }

    handleImageUpload(document.getElementById('uploadTarget'), 'targetImage', 'targetPlaceholder', true);
    handleImageUpload(document.getElementById('uploadCurrent'), 'currentImage', 'currentPlaceholder', false);


    // 이미지 비교 분석 함수
    function compareImages() {
        if (!targetImageSrc || !currentImageSrc) {
            alert("기준 이미지와 비교 이미지를 모두 업로드해주세요.");
            return;
        }

        const img1 = new Image();
        const img2 = new Image();
        let loadedCount = 0;

        const onImageLoad = () => {
            loadedCount++;
            if (loadedCount === 2) {
                // 이미지를 캔버스에 그려서 픽셀 데이터 추출
                const canvas1 = document.createElement('canvas');
                const canvas2 = document.createElement('canvas');
                
                // 두 이미지를 동일한 크기로 리사이즈하여 비교 (중요!)
                const width = Math.min(img1.width, img2.width, 200); // 최대 200px 정도로 줄여서 비교
                const height = Math.min(img1.height, img2.height, 200);

                canvas1.width = width;
                canvas1.height = height;
                canvas2.width = width;
                canvas2.height = height;

                const ctx1 = canvas1.getContext('2d');
                const ctx2 = canvas2.getContext('2d');

                ctx1.drawImage(img1, 0, 0, width, height);
                ctx2.drawImage(img2, 0, 0, width, height);

                const data1 = ctx1.getImageData(0, 0, width, height).data;
                const data2 = ctx2.getImageData(0, 0, width, height).data;

                let diffPixels = 0;
                for (let i = 0; i < data1.length; i += 4) { // RGBa 4개 채널
                    // R, G, B 채널의 차이를 합산
                    const rDiff = Math.abs(data1[i] - data2[i]);
                    const gDiff = Math.abs(data1[i + 1] - data2[i + 1]);
                    const bDiff = Math.abs(data1[i + 2] - data2[i + 2]);
                    
                    // 총 색상 차이가 임계값 이상이면 다른 픽셀로 간주 (여기서는 픽셀당 평균 차이가 30 이상)
                    if ((rDiff + gDiff + bDiff) / 3 > 30) { 
                        diffPixels++;
                    }
                }

                const totalPixels = (width * height);
                const matchRate = ((totalPixels - diffPixels) / totalPixels * 100).toFixed(1);

                const scoreDiv = document.getElementById('matchScore');
                const messageDiv = document.getElementById('matchMessage');
                
                scoreDiv.innerText = `${matchRate}%`;
                scoreDiv.classList.remove('good', 'bad');

                if (matchRate >= 80) { // 80% 이상이면 '좋음'
                    scoreDiv.classList.add('good');
                    messageDiv.innerText = "상당히 유사한 순무입니다! 합격!";
                } else if (matchRate >= 60) { // 60% 이상이면 '보통'
                    scoreDiv.classList.remove('good', 'bad'); // 기본 노란색
                    messageDiv.innerText = "유사하지만 약간 차이가 있습니다.";
                } else { // 60% 미만이면 '나쁨'
                    scoreDiv.classList.add('bad');
                    messageDiv.innerText = "다른 종류의 순무일 수 있습니다.";
                }
            }
        };

        img1.onload = onImageLoad;
        img2.onload = onImageLoad;

        img1.src = targetImageSrc;
        img2.src = currentImageSrc;
    }
</script>

</body>
</html>